---

- name: Include validate.yml
  tags: [ pmm, pmm-client, validate, pmm-validate, pmm-client-validate ]
  include: validate.yml

- name: Include procedures.yml
  tags: [ pmm, pmm-client, monitor-scripts-upgrade ]
  include: validate.yml

- name: Add Percona official RPM repository
  tags: [ pmm, pmm-client, percona-release-upgrade ]
  yum:
    name: "https://repo.percona.com/yum/percona-release-{{ percona_release_version }}.noarch.rpm"
    allow_downgrade: yes
    state: present

- name: Upgrade yum cache
  tags: [ pmm, pmm-client, pmm-client-upgrade ]
  yum:
    update_cache: yes

- name: Install pmm2-client
  tags: [ pmm, pmm-client, pmm-client-upgrade ]
  yum:
    name: "pmm2-client-{{ pmm_client_version }}"
    allow_downgrade: yes
    state: present

- name: Configure pmm2-client
  tags: [ pmm, pmm-client, pmm-client-configure, pmm-client-upgrade ]
  command: >
    "pmm-admin config --server-url=https://{{ pmm_server_user | urlencode }}:{{ pmm_server_password | urlencode }}@{{ pmm_server_host | urlencode }}:{{ pmm_server_port }} --server-insecure-tls --force"

- name: Remove MySQL service if present
  tags: [ pmm, pmm-client, pmm-client-configure ]
  command: >
    "pmm-admin remove mysql"
  ignore_error: yes

- name: Add MySQL service without query analytics
  tags: [ pmm, pmm-client, pmm-client-configure, pmm-client-upgrade ]
  command: >
    "pmm-admin add mysql --username={{ pmm_mariadb_username }} --password={{ pmm_mariadb_password }} --metrics-mode={{ pmm_client_monitoring_mode }} --query-source={{ pmm_client_query_source }} --environment={{ environment }} --cluster={{ cluster_name }} --replication-set={{ replication_set_name }}"
